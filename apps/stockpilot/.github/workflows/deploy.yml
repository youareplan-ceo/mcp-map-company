name: ğŸš€ StockPilot ìë™ ë°°í¬

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ì‘ì—…
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: stockpilot_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd backend
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    - name: ğŸ“¦ Node.js ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
    
    - name: ğŸ§ª Backend í…ŒìŠ¤íŠ¸
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/stockpilot_test
        REDIS_URL: redis://localhost:6379/0
        JWT_SECRET_KEY: test-secret-key
        OPENAI_API_KEYS: '["test-key-1", "test-key-2"]'
      run: |
        cd backend
        python -m pytest tests/ -v --cov=. --cov-report=xml
    
    - name: ğŸ§ª Frontend í…ŒìŠ¤íŠ¸
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false
    
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage.xml,./frontend/coverage/lcov.info
        flags: backend,frontend
        name: stockpilot-coverage

  # ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
  deploy-backend:
    name: ğŸ—ï¸ ë°±ì—”ë“œ ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸš€ Render ë°°í¬
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        wait-for-success: true
    
    - name: ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
        curl -f https://stockpilot-backend.onrender.com/health || exit 1
    
    - name: ğŸ“¬ Slack ì•Œë¦¼
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸ—ï¸ ë°±ì—”ë“œ ë°°í¬ ${{ job.status }}
          ë¸Œëœì¹˜: ${{ github.ref }}
          ì»¤ë°‹: ${{ github.sha }}

  # ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
  deploy-frontend:
    name: ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
    
    - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ
      env:
        REACT_APP_API_URL: https://stockpilot-backend.onrender.com
        REACT_APP_WS_URL: wss://stockpilot-websocket.onrender.com
        REACT_APP_VERSION: ${{ github.sha }}
        GENERATE_SOURCEMAP: false
      run: |
        cd frontend
        npm run build
    
    - name: ğŸš€ Vercel ë°°í¬
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-args: '--prod'
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: frontend
    
    - name: ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸
      run: |
        echo "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"
        sleep 30  # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        curl -f https://stockpilot-frontend.vercel.app/health || echo "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
    
    - name: ğŸ“¬ Slack ì•Œë¦¼
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ${{ job.status }}
          ë¸Œëœì¹˜: ${{ github.ref }}
          ì»¤ë°‹: ${{ github.sha }}

  # ğŸ” ë°°í¬ í›„ í†µí•© í…ŒìŠ¤íŠ¸
  e2e-test:
    name: ğŸ” E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“¦ Playwright ì„¤ì¹˜
      run: |
        npm install -g @playwright/test
        npx playwright install chromium
    
    - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      env:
        BACKEND_URL: https://stockpilot-backend.onrender.com
        FRONTEND_URL: https://stockpilot-frontend.vercel.app
      run: |
        # ì„œë¹„ìŠ¤ ì¤€ë¹„ ìƒíƒœ í™•ì¸
        timeout 300 bash -c 'until curl -f $BACKEND_URL/health; do sleep 5; done'
        
        # E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        cd e2e-tests
        npx playwright test
    
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: |
          e2e-tests/test-results/
          e2e-tests/playwright-report/
    
    - name: ğŸ“¬ ìµœì¢… ë°°í¬ ì•Œë¦¼
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸ‰ StockPilot ì „ì²´ ë°°í¬ ${{ job.status }}!
          
          ğŸ”— ë§í¬:
          â€¢ Frontend: https://stockpilot-frontend.vercel.app
          â€¢ Backend: https://stockpilot-backend.onrender.com
          â€¢ API Docs: https://stockpilot-backend.onrender.com/docs
          
          ğŸ“ ë³€ê²½ì‚¬í•­:
          ì»¤ë°‹: ${{ github.sha }}
          ë©”ì‹œì§€: ${{ github.event.head_commit.message }}
          
          ğŸ§ª E2E í…ŒìŠ¤íŠ¸: ${{ job.status }}

  # ğŸ§¹ ê°œë°œ í™˜ê²½ ë°°í¬ (develop ë¸Œëœì¹˜)
  deploy-staging:
    name: ğŸ§¹ ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸš€ ìŠ¤í…Œì´ì§• ë°°í¬ (Render)
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        wait-for-success: true
    
    - name: ğŸ“¬ ìŠ¤í…Œì´ì§• ì•Œë¦¼
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#development'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          ğŸ§¹ ìŠ¤í…Œì´ì§• ë°°í¬ ì™„ë£Œ
          ë¸Œëœì¹˜: develop
          URL: https://stockpilot-staging.onrender.com
          ì»¤ë°‹: ${{ github.sha }}

  # ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
  security:
    name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ” ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        cd backend
        pip install safety
        safety check
        
        cd ../frontend
        npm audit --audit-level high
    
    - name: ğŸ›¡ï¸ ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”
      uses: github/super-linter@v4
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_PYTHON: true
        VALIDATE_JAVASCRIPT: true
        VALIDATE_DOCKERFILE: true
        VALIDATE_YAML: true

  # ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  performance:
    name: ğŸ“ˆ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ Lighthouse CI
      uses: treosh/lighthouse-ci-action@v9
      with:
        urls: |
          https://stockpilot-frontend.vercel.app
          https://stockpilot-frontend.vercel.app/dashboard
        uploadArtifacts: true
        temporaryPublicStorage: true
    
    - name: ğŸ“Š ì„±ëŠ¥ ê²°ê³¼ ì•Œë¦¼
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#performance",
            "attachments": [{
              "color": "good",
              "fields": [{
                "title": "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ",
                "value": "Lighthouse ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                "short": false
              }]
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}