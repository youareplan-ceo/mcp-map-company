name: ğŸ” MCP-MAP CI/CD Pipeline (ë°±ì—…/ë³´ì•ˆ ë¡œê·¸ í†µí•©)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ“‹ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë° ë¦°íŒ…
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ ì¢…ì†ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    # ğŸ§ª ë°±ì—… ë° ë³´ì•ˆ ë¡œê·¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ” ë°±ì—… ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ” ë°±ì—… ê´€ë ¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        python -m pytest tests/test_backup_makefile.py -v --tb=short
        if [ -f tests/test_backup_and_logs.py ]; then
          python -m pytest tests/test_backup_and_logs.py -v --tb=short
        fi

    - name: ğŸ›¡ï¸ ë³´ì•ˆ ë¡œê·¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ›¡ï¸ ë³´ì•ˆ ë¡œê·¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        if [ -f tests/test_security_logger.py ]; then
          python -m pytest tests/test_security_logger.py -v --tb=short
        fi

    # ğŸ”„ ìš´ì˜ í†µí•© í…ŒìŠ¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
    - name: ğŸ”„ ìš´ì˜ í†µí•© ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ”„ ë³´ì•ˆ ë¡œê·¸ + ë°±ì—… ê´€ë¦¬ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        if [ -f tests/test_integration_ops.py ]; then
          python -m pytest tests/test_integration_ops.py -v -s --tb=short
        else
          echo "â“ test_integration_ops.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
        fi
      continue-on-error: true

    # ğŸ” Makefile ê¸°ë°˜ ë°±ì—… ê²€ì¦
    - name: ğŸ”§ ë°±ì—… ê²€ì¦ ë„êµ¬ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ”§ ë°±ì—… ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê°€ëŠ¥ì„± í™•ì¸..."
        chmod +x scripts/backup_verifier.sh
        # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
        mkdir -p backups
        echo "test backup content" > backups/test_backup_$(date +%Y%m%d).txt
        # ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰
        ./scripts/backup_verifier.sh --dry-run --json || echo "ë°±ì—… ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ"

    - name: ğŸ§¹ ë°±ì—… ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
      run: |
        echo "ğŸ§¹ ë°±ì—… ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰..."
        if [ -f scripts/cleanup_old_backups.sh ]; then
          chmod +x scripts/cleanup_old_backups.sh
          ./scripts/cleanup_old_backups.sh --dry-run || echo "ë°±ì—… ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ"
        else
          echo "cleanup_old_backups.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ìƒëµ"
        fi

    # ğŸ“Š ë³´ì•ˆ ë¡œê·¸ ìƒì„± í™•ì¸
    - name: ğŸ“Š ë³´ì•ˆ ë¡œê·¸ ìƒì„± í™•ì¸
      run: |
        echo "ğŸ“Š ë³´ì•ˆ ë¡œê·¸ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ìƒì„± í™•ì¸..."
        mkdir -p logs
        if [ ! -f logs/security.log ]; then
          echo "$(date '+%Y-%m-%d %H:%M:%S') - INFO - CI í…ŒìŠ¤íŠ¸ìš© ë³´ì•ˆ ë¡œê·¸ ìƒì„±" > logs/security.log
        fi
        echo "ë³´ì•ˆ ë¡œê·¸ íŒŒì¼ ì¡´ì¬ í™•ì¸: $(ls -la logs/security.log)"
        echo "ë³´ì•ˆ ë¡œê·¸ ë‚´ìš© í™•ì¸:"
        cat logs/security.log | tail -5

    # ğŸš¨ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸš¨ ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸš¨ ì „ì²´ pytest í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        python -m pytest tests/ -v --tb=short --maxfail=3
      continue-on-error: true

  # ğŸ“‹ CI í›„ì²˜ë¦¬ ë° ë¦¬í¬íŠ¸ ìƒì„±
  post-process:
    runs-on: ubuntu-latest
    needs: test
    if: always()  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œì—ë„ ì‹¤í–‰

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: ğŸ“Š CI í›„ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ“Š CI í›„ì²˜ë¦¬ ë° ë¦¬í¬íŠ¸ ìƒì„±..."
        chmod +x scripts/ci_post_process.sh
        ./scripts/ci_post_process.sh --github-actions
      continue-on-error: true

    # ğŸ“ ì›Œí¬í”Œë¡œ ë¡œê·¸ ë° ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì €ì¥
    - name: ğŸ“ CI ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ci-reports-${{ github.run_number }}
        path: |
          logs/
          reports/
          ci_summary.json
          ci_summary.txt
          logs/security.log
          backups/
        retention-days: 30

    # ğŸ”” ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (í™˜ê²½ë³€ìˆ˜ë¡œ ì›¹í›… ì„¤ì • ì‹œ)
    - name: ğŸ”” ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
      if: failure() && env.SLACK_WEBHOOK_URL
      run: |
        echo "ğŸ”” CI ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡..."
        if [ -f scripts/ci_post_process.sh ]; then
          ./scripts/ci_post_process.sh --notify-failure
        fi
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}