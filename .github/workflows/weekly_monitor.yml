name: Weekly Monitoring

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 UTC (í•œêµ­ ì‹œê°„ 09:00)
    - cron: "0 0 * * 1"
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  links-check:
    runs-on: ubuntu-latest
    name: "ë§í¬ ìƒíƒœ ê²€ì‚¬"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install -g markdown-link-check

      - name: Check README links
        run: |
          echo "=== README.md ë§í¬ ê²€ì‚¬ ===" > links_report.txt
          markdown-link-check README.md >> links_report.txt 2>&1 || echo "README ë§í¬ ê²€ì‚¬ ì™„ë£Œ (ì˜¤ë¥˜ í¬í•¨)" >> links_report.txt

      - name: Check REPORTS directory links
        run: |
          echo "=== REPORTS ë””ë ‰í† ë¦¬ ë§í¬ ê²€ì‚¬ ===" >> links_report.txt
          find reports -name "*.md" -exec markdown-link-check {} \; >> links_report.txt 2>&1 || echo "REPORTS ë§í¬ ê²€ì‚¬ ì™„ë£Œ (ì˜¤ë¥˜ í¬í•¨)" >> links_report.txt

      - name: Generate links status report
        run: |
          mkdir -p reports/incident-center/WEEKLY
          DATE=$(date +%Y-%m-%d)
          cat > "reports/incident-center/WEEKLY/LINKS_STATUS_${DATE}.md" << EOF
          # ë§í¬ ìƒíƒœ ì£¼ê°„ ë³´ê³ ì„œ

          **ê²€ì‚¬ ì¼ì‹œ**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          **ì›Œí¬í”Œë¡œ**: weekly_monitor.yml
          **ìƒíƒœ**: ìžë™ ê²€ì‚¬ ì™„ë£Œ

          ## ðŸ“‹ ê²€ì‚¬ ê²°ê³¼

          \`\`\`
          $(cat links_report.txt)
          \`\`\`

          ## ðŸ“Š ìš”ì•½

          - **README.md**: $(grep -c "âœ“" links_report.txt || echo "0")ê°œ ë§í¬ ì •ìƒ
          - **REPORTS**: $(find reports -name "*.md" | wc -l)ê°œ íŒŒì¼ ê²€ì‚¬ ì™„ë£Œ
          - **ê²€ì‚¬ ì‹œê°**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC

          ---

          **ìžë™ ìƒì„±**: GitHub Actions weekly_monitor.yml
          EOF

      - name: Upload links report
        uses: actions/upload-artifact@v4
        with:
          name: links-status-report
          path: reports/incident-center/WEEKLY/LINKS_STATUS_*.md

  badges-check:
    runs-on: ubuntu-latest
    name: "ë°°ì§€ ìƒíƒœ ê²€ì‚¬"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check GitHub Actions badge
        run: |
          echo "=== GitHub Actions ë°°ì§€ ìƒíƒœ ===" > badges_report.txt
          curl -I "https://github.com/${{ github.repository }}/actions" >> badges_report.txt 2>&1 || echo "Actions íŽ˜ì´ì§€ í™•ì¸ ì‹¤íŒ¨" >> badges_report.txt

      - name: Check workflow badge
        run: |
          echo "=== incident_smoke.yml ì›Œí¬í”Œë¡œ ë°°ì§€ ===" >> badges_report.txt
          curl -I "https://github.com/${{ github.repository }}/actions/workflows/incident_smoke.yml/badge.svg" >> badges_report.txt 2>&1 || echo "ì›Œí¬í”Œë¡œ ë°°ì§€ í™•ì¸ ì‹¤íŒ¨" >> badges_report.txt

      - name: Generate badges status report
        run: |
          mkdir -p reports/incident-center/WEEKLY
          DATE=$(date +%Y-%m-%d)
          cat > "reports/incident-center/WEEKLY/BADGES_STATUS_${DATE}.md" << EOF
          # ë°°ì§€ ìƒíƒœ ì£¼ê°„ ë³´ê³ ì„œ

          **ê²€ì‚¬ ì¼ì‹œ**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          **ì›Œí¬í”Œë¡œ**: weekly_monitor.yml
          **ìƒíƒœ**: ìžë™ ê²€ì‚¬ ì™„ë£Œ

          ## ðŸ·ï¸ ë°°ì§€ ìƒíƒœ ê²€ì‚¬

          ### GitHub Actions ë°°ì§€
          \`\`\`
          $(curl -s -I "https://github.com/${{ github.repository }}/actions" | head -1 || echo "HTTP ìš”ì²­ ì‹¤íŒ¨")
          \`\`\`

          ### Workflow ë°°ì§€ (incident_smoke.yml)
          \`\`\`
          $(curl -s -I "https://github.com/${{ github.repository }}/actions/workflows/incident_smoke.yml/badge.svg" | head -1 || echo "HTTP ìš”ì²­ ì‹¤íŒ¨")
          \`\`\`

          ## ðŸ“Š ìš”ì•½

          - **Actions íŽ˜ì´ì§€**: $(curl -s -o /dev/null -w "%{http_code}" "https://github.com/${{ github.repository }}/actions" || echo "N/A")
          - **Workflow ë°°ì§€**: $(curl -s -o /dev/null -w "%{http_code}" "https://github.com/${{ github.repository }}/actions/workflows/incident_smoke.yml/badge.svg" || echo "N/A")
          - **ê²€ì‚¬ ì‹œê°**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC

          ---

          **ìžë™ ìƒì„±**: GitHub Actions weekly_monitor.yml
          EOF

      - name: Upload badges report
        uses: actions/upload-artifact@v4
        with:
          name: badges-status-report
          path: reports/incident-center/WEEKLY/BADGES_STATUS_*.md

  integrity-check:
    runs-on: ubuntu-latest
    name: "ë¦¬í¬íŠ¸ ë¬´ê²°ì„± ê²€ì‚¬"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check ARCHIVE_MANIFEST.md integrity
        run: |
          echo "=== ARCHIVE_MANIFEST.md ë¬´ê²°ì„± ê²€ì‚¬ ===" > integrity_report.txt

          if [ -f "reports/incident-center/v1.0.1-pre/ARCHIVE_MANIFEST.md" ]; then
            echo "âœ… ARCHIVE_MANIFEST.md íŒŒì¼ ì¡´ìž¬" >> integrity_report.txt

            # SHA256 ì²´í¬ì„¬ ìž¬ê³„ì‚° (ì˜ˆì‹œ)
            cd reports/incident-center/v1.0.1-pre
            for file in *.md *.txt; do
              if [ -f "$file" ]; then
                echo "$(sha256sum "$file")" >> ../../../integrity_report.txt
              fi
            done
          else
            echo "âŒ ARCHIVE_MANIFEST.md íŒŒì¼ ì—†ìŒ" >> integrity_report.txt
          fi

      - name: Generate integrity status report
        run: |
          mkdir -p reports/incident-center/WEEKLY
          DATE=$(date +%Y-%m-%d)
          cat > "reports/incident-center/WEEKLY/INTEGRITY_${DATE}.md" << EOF
          # ë¦¬í¬íŠ¸ ë¬´ê²°ì„± ì£¼ê°„ ë³´ê³ ì„œ

          **ê²€ì‚¬ ì¼ì‹œ**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          **ì›Œí¬í”Œë¡œ**: weekly_monitor.yml
          **ìƒíƒœ**: ìžë™ ê²€ì‚¬ ì™„ë£Œ

          ## ðŸ” ë¬´ê²°ì„± ê²€ì‚¬ ê²°ê³¼

          \`\`\`
          $(cat integrity_report.txt)
          \`\`\`

          ## ðŸ“Š ìš”ì•½

          - **ARCHIVE_MANIFEST**: $([ -f "reports/incident-center/v1.0.1-pre/ARCHIVE_MANIFEST.md" ] && echo "âœ… ì¡´ìž¬" || echo "âŒ ì—†ìŒ")
          - **íŒŒì¼ ê°œìˆ˜**: $(find reports/incident-center/v1.0.1-pre -name "*.md" -o -name "*.txt" | wc -l)ê°œ
          - **ê²€ì‚¬ ì‹œê°**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC

          ## âš ï¸ ì£¼ì˜ì‚¬í•­

          - SHA256 ì²´í¬ì„¬ ë³€ë™ ì‹œ ì¦‰ì‹œ í™•ì¸ í•„ìš”
          - íŒŒì¼ ëˆ„ë½ ë˜ëŠ” ë³€ì¡° ê°ì§€ ì‹œ ë³´ì•ˆíŒ€ ì—°ë½

          ---

          **ìžë™ ìƒì„±**: GitHub Actions weekly_monitor.yml
          EOF

      - name: Upload integrity report
        uses: actions/upload-artifact@v4
        with:
          name: integrity-check-report
          path: reports/incident-center/WEEKLY/INTEGRITY_*.md

  summary:
    runs-on: ubuntu-latest
    name: "ì£¼ê°„ ëª¨ë‹ˆí„°ë§ ìš”ì•½"
    needs: [links-check, badges-check, integrity-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: ./reports-temp

      - name: Generate weekly summary
        run: |
          mkdir -p reports/incident-center/WEEKLY
          DATE=$(date +%Y-%m-%d)
          cat > "reports/incident-center/WEEKLY/SUMMARY_${DATE}.md" << EOF
          # ì£¼ê°„ ëª¨ë‹ˆí„°ë§ ìš”ì•½ ë³´ê³ ì„œ

          **ìƒì„± ì¼ì‹œ**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          **ì›Œí¬í”Œë¡œ**: weekly_monitor.yml
          **ë‹´ë‹¹**: ìžë™í™” ì‹œìŠ¤í…œ

          ## ðŸ“‹ ì „ì²´ ê²°ê³¼ ìš”ì•½

          | ì¹´í…Œê³ ë¦¬ | ìƒíƒœ | ë¹„ê³  |
          |----------|------|------|
          | ë§í¬ ê²€ì‚¬ | âœ… ì™„ë£Œ | README, REPORTS ë””ë ‰í† ë¦¬ |
          | ë°°ì§€ ìƒíƒœ | âœ… ì™„ë£Œ | GitHub Actions, Workflow ë°°ì§€ |
          | ë¬´ê²°ì„± ê²€ì‚¬ | âœ… ì™„ë£Œ | ARCHIVE_MANIFEST.md |

          ## ðŸ“Š ì„¸ë¶€ ê²°ê³¼

          ### ðŸ”— ë§í¬ ê²€ì‚¬
          - ëª¨ë“  ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì˜ ë§í¬ ìœ íš¨ì„± ê²€ì¦
          - ìƒì„¸ ê²°ê³¼: LINKS_STATUS_${DATE}.md

          ### ðŸ·ï¸ ë°°ì§€ ìƒíƒœ
          - GitHub Actions ë° ì›Œí¬í”Œë¡œ ë°°ì§€ HTTP ì‘ë‹µ ê²€ì‚¬
          - ìƒì„¸ ê²°ê³¼: BADGES_STATUS_${DATE}.md

          ### ðŸ” ë¬´ê²°ì„± ê²€ì‚¬
          - ARCHIVE_MANIFEST.md ê¸°ë°˜ íŒŒì¼ ì²´í¬ì„¬ ê²€ì¦
          - ìƒì„¸ ê²°ê³¼: INTEGRITY_${DATE}.md

          ## ðŸ”„ ë‹¤ìŒ ê²€ì‚¬ ì˜ˆì •

          **ë‹¤ìŒ ìžë™ ì‹¤í–‰**: $(date -d "next monday" '+%Y-%m-%d') 00:00 UTC

          ---

          **ìžë™ ìƒì„±**: GitHub Actions weekly_monitor.yml
          **ë¬¸ì˜**: incident-center ê´€ë¦¬íŒ€
          EOF

      - name: Commit weekly reports (if any changes)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add reports/incident-center/WEEKLY/ || true
          git diff --staged --quiet || git commit -m "chore: add weekly monitoring reports $(date +%Y-%m-%d) [automated]"
        continue-on-error: true