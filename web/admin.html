<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StockPilot AI</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --text: #e8f0ff;
      --muted: #96a0b5;
      --accent: #3aa0ff;
      --ok: #16c782;
      --warn: #ffb020;
      --bad: #ff5b5b;
      --card: linear-gradient(135deg, #0f1b31 0%, #0d1930 100%);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .container{max-width:1100px;margin:32px auto;padding:0 20px}
    .topbar{
      background:#ffe8a3;color:#333;border-radius:10px;padding:10px 14px;
      font-size:12px;margin:0 auto 16px; text-align:center;
    }
    h1{font-size:28px;margin:20px 0 16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 12;background:var(--card);border:1px solid #1f2a42;border-radius:14px;padding:18px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .kpi{background:#0c1628;border:1px solid #1f2947;border-radius:12px;padding:14px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;margin-top:6px}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0f223f;border:1px solid #203656;color:#9fb7de}
    .btn{appearance:none;border:0;outline:0;border-radius:12px;background:var(--accent);color:#00162a;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#142238;color:#b9c8e6;border:1px solid #263654}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .signals{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    .sig{background:#0c1628;border:1px solid #1f2947;border-radius:12px;padding:14px}
    .sig .title{font-weight:700}
    .sig .msg{color:#b9c8e6;margin-top:8px;min-height:38px}
    .sig.buy {border-color:#184c38; box-shadow:0 0 0 1px rgba(22,199,130,.15) inset}
    .sig.sell{border-color:#4c1820; box-shadow:0 0 0 1px rgba(255,91,91,.12) inset}
    .sig.hold{border-color:#3b3b55; box-shadow:0 0 0 1px rgba(120,120,160,.12) inset}
    .status{margin:14px 0 0;font-size:12px;color:#99a6c4}
    .error{color:var(--bad)}
    .ok{color:var(--ok)}
    .footer{opacity:.6;text-align:center;font-size:12px;margin:26px 0}
    @media (max-width: 960px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .signals{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">본 서비스는 AI 기반 분석 도구입니다. 투자 권유가 아닌 참고 자료이며, 모든 투자 결정과 책임은 이용자에게 있습니다.</div>

    <div class="row" style="margin-bottom:10px">
      <h1 style="margin:0">StockPilot AI</h1>
      <div class="flex">
        <span class="pill" id="connectionStatus">연결 확인 중…</span>
        <button id="retryBtn" class="btn secondary">다시 연결</button>
      </div>
    </div>

    <!-- 요약 카드 -->
    <div class="card">
      <div class="row">
        <div>
          <div style="opacity:.7;font-size:14px">총 자산</div>
          <div id="totalValue" style="font-size:36px;margin-top:6px;">—</div>
          <div class="flex" style="margin-top:10px">
            <span class="pill">현금 비중 <b id="cashRatio">—</b>%</span>
            <span class="pill">보유 종목 <b id="stockCount">—</b></span>
            <span class="pill">월 수익률 <b id="monthlyReturn">—</b>%</span>
            <span class="pill">위험도 <b id="riskLevel">—</b></span>
          </div>
        </div>
        <div class="flex">
          <button id="refreshBtn" class="btn">실시간 업데이트</button>
        </div>
      </div>

      <!-- KPI -->
      <div class="kpis">
        <div class="kpi"><div class="label">누적 수익</div><div class="value" id="profit">—</div></div>
        <div class="kpi"><div class="label">수익률</div><div class="value" id="profitPct">—</div></div>
        <div class="kpi"><div class="label">상태</div><div class="value ok" id="apiHealth">확인 중…</div></div>
        <div class="kpi"><div class="label">마지막 갱신</div><div class="value" id="lastCheck">—</div></div>
      </div>

      <!-- 시그널 -->
      <h3 style="margin:18px 0 6px">AI 시그널</h3>
      <div class="signals" id="signalsWrap">
        <!-- JS로 채움 -->
      </div>

      <div class="status" id="statusLine"></div>
    </div>

    <div class="footer">© StockPilot / MCP Map Company</div>
  </div>

  <script>
    // ====== 설정 (필요하면 여기만 바꿔도 됨) ======
    const API_BASE = 'https://mcp-map-company.onrender.com';
    const SIGNALS_URL = `${API_BASE}/api/v1/ai/signals`;
    const HEALTH_URL  = `${API_BASE}/health`;

    // ====== 유틸 ======
    const fmtKRW = v => {
      try {
        return new Intl.NumberFormat('ko-KR', { style:'currency', currency:'KRW', maximumFractionDigits:0 }).format(v);
      } catch { return `${v}`; }
    };
    const fmtPct = v => `${Number(v).toFixed(1)}%`;
    const el = id => document.getElementById(id);

    // ====== 렌더러 ======
    function renderPortfolio(p) {
      el('totalValue').textContent   = fmtKRW(p.totalValue ?? 0);
      el('cashRatio').textContent    = Number(p.cashRatio ?? 0).toFixed(0);
      el('stockCount').textContent   = p.stockCount ?? 0;
      el('monthlyReturn').textContent= Number(p.monthlyReturn ?? 0).toFixed(1);
      el('riskLevel').textContent    = p.riskLevel ?? '—';
      el('profit').textContent       = fmtKRW(p.profit ?? 0);
      el('profitPct').textContent    = `${Number(p.profitPercentage ?? 0).toFixed(1)}%`;
    }

    function renderSignals(list) {
      const wrap = el('signalsWrap');
      wrap.innerHTML = '';
      (list || []).slice(0, 6).forEach(sig => {
        const type = (sig.action || 'hold').toLowerCase();
        const div = document.createElement('div');
        div.className = `sig ${type}`;
        div.innerHTML = `
          <div class="title">${sig.symbol} · ${type.toUpperCase()}</div>
          <div class="msg">${sig.message || '—'}</div>
          <div class="row" style="margin-top:10px">
            <span class="pill">수량 ${sig.quantity ?? '-'}주</span>
            <span class="pill">가격 ${sig.price ? fmtKRW(sig.price*1400) : '—'}</span>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    function setStatus(ok, msg){
      el('connectionStatus').textContent = ok ? '연결 정상' : '연결 끊김';
      el('connectionStatus').style.background = ok ? '#0e2f22' : '#2f0e10';
      el('connectionStatus').style.color = ok ? '#8af3c7' : '#ffb3b3';
      el('apiHealth').textContent = ok ? 'OK' : '오류';
      el('apiHealth').className = ok ? 'value ok' : 'value error';
      el('statusLine').textContent = msg || '';
      el('lastCheck').textContent = new Date().toLocaleString();
    }

    async function getJSON(url, opts={}){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), opts.timeout ?? 10000);
      try {
        const res = await fetch(url, {
          method: 'GET',
          mode: 'cors',
          credentials: 'omit',
          cache: 'no-store',
          signal: ctrl.signal,
          headers: { 'Accept': 'application/json' }
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function loadHealth(){
      try{
        await getJSON(HEALTH_URL,{timeout:6000});
        setStatus(true, 'API 연결 성공');
        return true;
      }catch(e){
        setStatus(false, `API 연결 실패: ${e.message}`);
        return false;
      }
    }

    async function loadSignals(){
      try{
        const data = await getJSON(SIGNALS_URL,{timeout:8000});
        if(data?.portfolio) renderPortfolio(data.portfolio);
        if(data?.signals)   renderSignals(data.signals);
        setStatus(true, '시그널 최신 데이터 반영됨');
      }catch(e){
        setStatus(false, `시그널 로드 실패: ${e.message}`);
        // 화면은 유지
      }
    }

    async function bootstrap(){
      const ok = await loadHealth();
      if(ok) await loadSignals();
    }

    // 이벤트
    el('retryBtn').addEventListener('click', bootstrap);
    el('refreshBtn').addEventListener('click', loadSignals);

    // 첫 진입
    bootstrap();
  </script>
</body>
</html>
